meta-intel-bsp
==============

This is the OpenEmbedded/Yocto layer for Intel Axxia x86_64 BSPs based
on Intel Snow Ridge and Intel Grand Ridge CPUs.
This layer contains the official machine configuration file and kernel
recipes with patches and fragments.


Supported MACHINES
==================

- intel-axxia-snr - This BSP is optimized for Intel Axxia x86 Gen3 Mobile &
  Enterprise Communication Processors family (64-bit) such as Snow Ridge SoCs.

- intel-axxia-grr - This BSP is optimized for Intel Axxia x86 Gen4 Mobile &
  Enterprise Communication Processors family (64-bit) such as Grand Ridge SoCs.
                
Please refer to the associate .conf for more information.


Reference platforms
===================

- Victoria Canyon board (VCN) for SNR machine

- Travertine Fall board (TVF) for GRR machine

- Advanced Simulation Environment (ASE)


Dependencies
============

Intel Meta Layer
----------------
URI: git://git.yoctoproject.org/meta-intel

Check DEPENDENCIES.distro for branch and revision.


Table of Contents
=================

 I. Back Ported Linux Changes
II. Building meta-intel-bsp
    1. Build Intel Axxia reference platform
    2. Building with other OpenEmbedded/Yocto layers


I. Back Ported Linux Changes
============================

Some changes have been up-streamed, but have not yet been back ported
to Linux 5.15 or 5.10. Some of these have been added to this meta layer.
The changes are described below. In each case, any changes required are
described and the publically available patch is referenced. Only changes
functionally required for internal testing have been back ported.

The "title" of the commit (Subject: or first line) is used to identify
the commit, as this is the easiest way to find it in the repositories.

In the following descriptions, "with no changes" means that a patch
was obtained using 'git format-patch -1 <sha>' from the referenced
respoistory and was applied using 'git am -3 <patch>'.

In the meta layer, the patches for Linux 5.15 can be found in
meta-intel-bsp/recipes-kernel/linux/patches/5.15 and for 5.10 in
meta-intel-bsp/recipes-kernel/linux/patches/5.10.


drivers/watchdog: Ignore 'No Reboot' Bit
----------------------------------------

This has not been upstreamed, and there is no plan to upstream it.

Early versions of the SNR chip do not allow the "no reboot" bit to be
accessed.  This commit simply assumes that it is writeable without
checking in order to allow the watchdog to but used in Linux.  This
will be fixed in later versions of the chip.

Note that, by default, this patch will do nothing.  To enable it, add
'iTCO_wdt.assume_noreboot_access=1' to the Linux command line.

Included as 0001-drivers-watchdog-Ignore-No-Reboot-Bit.patch


clocksource: Add option to force acpi_pm as clocksource watchdog
----------------------------------------------------------------

Add a kernel command line option to force the use of acpi_pm as the
watchdog clocksource. To use it, add the following to the kernel
command line:

    ricardo_clocksource_wd=force_acpi_pm_wd

and in dmesg look for:

    RICARDO: Force acpi_pm as watchdog

Included as
0002-clocksource-Add-option-to-force-acpi_pm-as-clocksour.patch


libata: add horkage for missing Identify Device log
---------------------------------------------------

Back-ported from 5.19 to fix a boot regression in ASE caused by commit
e449d2e69a ("ata: libata: add missing ata_identify_page_supported()
calls"): VFS: Cannot open root device "PARTUUID=<uuid>" or 
unknown-block(0,0): error -6. Bug traced as B0265.

Included as
0004-libata-add-horkage-for-missing-Identify-Device-log.patch


Patches for perf (only for SNR, kernel 5.10)
--------------------------------------------

0001-perf-Cap-allocation-order-at-aux_watermark.patch and
0002-perf-intel-pt-Use-aux_watermark.patch.

Removes some limitations to the use of PTWRITE.  Without the above
'perf record' and 'per script' issue warnings about lost data.


Support Serial Flash Access (MTD) to Boot Flash
--------------------------------------------------------------

Allows access to the secondary boot flash from Linux using the MTD driver.

0007-mtd-spi-nor-intel-spi-Move-platform-data-header-to-x.patch (only for kernel 5.10)
0008-mtd-spi-nor-intel-spi-Add-support-for-second-flash-c.patch
0009-Introduce-an-Intel-SPI-controller-level-mutex.patch


Support for SIOV (only for GRR)
-------------------------------

0001-platform-msi-Add-device-MSI-infrastructure.patch
0002-genirq-msi-Provide-helpers-to-return-Linux-IRQ-dev_m.patch


TCO Functionality
-----------------

0003-watchdog-iTCO_wdt-use-module_platform_device-macro.patch (only for kernel 5.10)
0004-watchdog-iTCO_wdt-use-dev_err-instead-of-pr_err.patch (only for kernel 5.10)
0005-watchdog-iTCO_wdt-No-need-to-stop-the-timer-in-probe.patch


Allow Displaying and Change Reboot Flags via SYSFS
--------------------------------------------------

0006-reboot-allow-to-specify-reboot-mode-via-sysfs.patch


MDEV Functions (only for kernel 5.10)
-------------------------------------

GRR only.  Back-ported from lkml.org to support building DLB with MDEV.

0003-vfio-mdev-Add-a-member-for-iommu-domain-in-mdev_devi.patch
0004-vfio-type1-Save-domain-when-attach-domain-to-mdev.patch

Disable MEI Driver on Ignition FW (only for kernel 5.10)
--------------------------------------------------------

This avoids errors in the system logs.

0005-mei-kdoc-fix-partial-back-port.patch
0006-mei-me-disable-driver-on-the-ign-firmware.patch


Add support to change default domain of an iommu group
------------------------------------------------------

Most of the patch is from

  https://lists.linuxfoundation.org/pipermail/iommu/2019-August/038337.html

with the addition of the GRR endpoint (8086:0dbd) in
drivers/iommu/intel/iommu.c.

NOTE: This doesn't supported using the /sys filesystem interface.

0007-iommu-Add-support-to-change-default-domain-of-an-iom.patch


Back port EDAC Changes for GRR
------------------------------

0008-Revert-EDAC-i10nm-Retrieve-and-print-retry_rd_err_lo.patch
0009-EDAC-i10nm-Add-detection-of-memory-levels-for-ICX-SP.patch
0010-EDAC-i10nm-Add-support-for-high-bandwidth-memory.patch
0011-EDAC-i10nm-Retrieve-and-print-retry_rd_err_log-1.patch
0012-EDAC-igen6-Make-sure-no-pending-errors.patch
0013-EDAC-igen6-Add-several-Intel-Alder-Lake-N-SoCs-suppo.patch
0014-EDAC-igen6-Add-another-Intel-Alder-Lake-SoC-support.patch
0015-EDAC-igen6-Add-another-Intel-Tiger-Lake-SoC-support.patch
0016-EDAC-skx_common-Add-new-ADXL-components-for-2-level-.patch
0017-EDAC-skx_common-Add-a-callback-of-decoding-errors-vi.patch
0018-EDAC-i10nm-Retrieve-and-print-retry_rd_err_log-2.patch
0019-EDAC-i10nm-Print-an-extra-register-set-of-retry_rd_e.patch
0020-EDAC-i10nm-Make-more-configurations-CPU-model-specif.patch
0021-EDAC-skx_common-Add-ChipSelect-ADXL-component.patch
0022-EDAC-i10nm-Add-Intel-Granite-Rapids-server-support.patch
0023-EDAC-i10nm-Add-Intel-Grand-Ridge-micro-server-suppor.patch


II. Building meta-intel-bsp
===========================

1. Build Intel Axxia reference platform
---------------------------------------

To build a full Intel Axxia reference platform, please follow the
instructions from README.distro file.


2. Build with other OpenEmbedded/Yocto layers
---------------------------------------------

In order to build meta-intel-bsp layer with other yocto-compatible layers,
such as Wind River Linux ones, the following additional steps
are required:

    bitbake-layers add-layer <path-to-layer>/meta-intel
    bitbake-layers add-layer <path-to-layer>/meta-intel-bsp

In local.conf, set intel-axxia-snr or intel-axxia-grr machine, choose
linux-intel kernel provider and add to the white list the following
packages if necesary:

    PNWHITELIST_intel += " thermald intel-microcode iucode-tool"
    PNWHITELIST_intel += " linux-intel linux-intel-rt"
    
Also, be sure linux-intel is not blacklisted somewhere in other layers.
