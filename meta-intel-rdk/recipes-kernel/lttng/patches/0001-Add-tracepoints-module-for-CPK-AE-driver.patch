From 8cdb9b900fec94433e11489cc444ac060162ea5d Mon Sep 17 00:00:00 2001
From: Ben Shelton <benjamin.h.shelton@intel.com>
Date: Fri, 10 Jul 2020 17:20:07 +0000
Subject: [PATCH 1/2] Add tracepoints module for CPK-AE driver

Signed-off-by: Ben Shelton <benjamin.h.shelton@intel.com>
---
 instrumentation/events/lttng-module/nis_ae.h | 14 ++++++++++
 probes/Kbuild                                |  4 +++
 probes/lttng-probe-nis-ae.c                  | 27 ++++++++++++++++++++
 3 files changed, 45 insertions(+)
 create mode 100644 instrumentation/events/lttng-module/nis_ae.h
 create mode 100644 probes/lttng-probe-nis-ae.c

diff --git a/instrumentation/events/lttng-module/nis_ae.h b/instrumentation/events/lttng-module/nis_ae.h
new file mode 100644
index 0000000..9d19b39
--- /dev/null
+++ b/instrumentation/events/lttng-module/nis_ae.h
@@ -0,0 +1,14 @@
+#undef TRACE_SYSTEM
+#define TRACE_SYSTEM nis_ae
+
+#if !defined(_LTTNG_NIS_AE_H) || defined(TRACE_HEADER_MULTI_READ)
+#define _LTTNG_NIS_AE_H
+
+#include "../../../probes/lttng-tracepoint-event.h"
+#include <linux/tracepoint.h>
+
+#include "ice_sw_ae_tracepoints_kmod.h"
+
+#endif /* !defined(_LTTNG_NIS_AE_H) || defined(TRACE_HEADER_MULTI_READ) */
+
+#include "../../../probes/define_trace.h"
diff --git a/probes/Kbuild b/probes/Kbuild
index cc1c065..9abae2f 100644
--- a/probes/Kbuild
+++ b/probes/Kbuild
@@ -266,4 +266,8 @@ ifneq ($(CONFIG_DYNAMIC_FTRACE),)
   endif
 endif # CONFIG_DYNAMIC_FTRACE
 
+CFLAGS_lttng-probe-nis-ae.o += -I$(srctree)/drivers/staging/intel/$(RDK_KLM_VERSION)/ice_sw_ae
+CFLAGS_lttng-probe-nis-ae.o += -I$(srctree)/drivers/staging/intel/$(RDK_KLM_VERSION)/ice_sw_ae/lttng
+obj-$(CONFIG_LTTNG) += lttng-probe-nis-ae.o
+
 # vim:syntax=make
diff --git a/probes/lttng-probe-nis-ae.c b/probes/lttng-probe-nis-ae.c
new file mode 100644
index 0000000..d457073
--- /dev/null
+++ b/probes/lttng-probe-nis-ae.c
@@ -0,0 +1,27 @@
+#include <linux/module.h>
+#include "../lttng-tracer.h"
+
+/*
+ * Build-time verification of mismatch between mainline
+ * TRACE_EVENT() arguments and the LTTng-modules adaptation
+ * layer LTTNG_TRACEPOINT_EVENT() arguments.
+ */
+#include <ice_sw_ae_tracepoints.h>
+
+#undef TRACE_INCLUDE_PATH
+#undef TRACE_INCLUDE_FILE
+
+/* Create LTTng tracepoint probes */
+#define LTTNG_PACKAGE_BUILD
+#define CREATE_TRACE_POINTS
+#define TRACE_INCLUDE_PATH ../instrumentation/events/lttng-module
+
+#include "../instrumentation/events/lttng-module/nis_ae.h"
+
+MODULE_LICENSE("GPL and additional rights");
+MODULE_AUTHOR("Ben Shelton <benjamin.h.shelton@intel.com>");
+MODULE_DESCRIPTION("LTTng probes for the NIS-AE driver");
+MODULE_VERSION(__stringify(LTTNG_MODULES_MAJOR_VERSION) "."
+	       __stringify(LTTNG_MODULES_MINOR_VERSION) "."
+	       __stringify(LTTNG_MODULES_PATCHLEVEL_VERSION)
+	       LTTNG_MODULES_EXTRAVERSION);
-- 
2.17.1

